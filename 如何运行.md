# ManimGo 如何运行 - 快速指南

## 核心变化

✅ **已放弃**: Motia 框架 (有严重 Windows 兼容性问题)  
✅ **现在使用**: Express.js + Bull + Redis (标准 Node.js 技术栈)

---

## 方式一：本地开发运行 (推荐用于开发)

### 前置要求
1. **Node.js** >= 18.0.0
2. **Python** 3.11+ (用于 Manim)
3. **Redis** 服务器 (用于任务队列)
4. **Manim** 库 (Python 动画引擎)

### 步骤

#### 1. 安装 Node.js 依赖
```bash
npm install
```

#### 2. 启动 Redis
**选项 A - Windows 本地 Redis**:
```bash
# 如果已安装 Redis，直接启动
redis-server
```

**选项 B - 使用 Docker 只运行 Redis**:
```bash
docker run -d -p 6379:6379 redis:7-alpine
```

**选项 C - 使用项目提供的脚本** (如果有):
```bash
node start-with-redis.cjs
```

#### 3. 配置环境变量
复制 `.env.example` 到 `.env`:
```bash
cp .env.example .env
```

编辑 `.env` 文件，填入你的配置:
```env
OPENAI_API_KEY=sk-your-key-here
OPENAI_MODEL=gpt-4.1-nano
NODE_ENV=development
```

#### 4. 安装 Manim (Python)
```bash
pip install manim==0.18.0
```

#### 5. 启动开发服务器
```bash
npm run dev
```

访问: http://localhost:3000

---

## 方式二：使用 Docker Compose (推荐用于生产)

### 前置要求
- **Docker** 和 **Docker Compose**

### 步骤

#### 1. 配置环境变量
编辑 `.env` 文件:
```env
OPENAI_API_KEY=sk-your-key-here
OPENAI_MODEL=gpt-4.1-nano
NODE_ENV=production
```

#### 2. 一键启动所有服务
```bash
docker-compose up -d
```

这会自动启动:
- ✅ Redis 服务 (端口 6379)
- ✅ ManimGo 服务 (端口 3000)

#### 3. 查看日志
```bash
docker-compose logs -f
```

#### 4. 停止服务
```bash
docker-compose down
```

---

## 方式三：生产环境部署 (不使用 Docker)

### 前置要求
1. **Node.js** >= 18.0.0
2. **Python** 3.11+
3. **Redis** 服务器
4. **Manim** 库
5. **系统依赖** (ffmpeg, LaTeX, Cairo, Pango 等)

### 步骤

#### 1. 构建项目
```bash
npm install
npm run build
```

#### 2. 启动 Redis
```bash
redis-server
```

#### 3. 配置环境变量
```bash
export NODE_ENV=production
export REDIS_HOST=localhost
export REDIS_PORT=6379
export OPENAI_API_KEY=sk-your-key-here
```

#### 4. 启动服务器
```bash
npm start
```

或使用 PM2:
```bash
npm install -g pm2
pm2 start dist/server.js --name manim-go
```

---

## 常见问题

### Q1: 我必须用 Docker 吗？
**不需要**！Docker 只是一个**可选的部署方式**，有以下选择：

| 方式 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **本地开发** | 简单快速 | 需要手动安装依赖 | 开发调试 |
| **Docker Compose** | 一键启动 | 需要 Docker | 生产部署/测试 |
| **裸机部署** | 性能最优 | 配置复杂 | 专业运维 |

### Q2: Redis 是必须的吗？
**是的**！Redis 用于：
- 任务队列 (Bull)
- 任务状态存储
- 概念缓存

但你可以选择运行 Redis 的方式：
- 本地安装 Redis
- Docker 运行 Redis
- 云服务 Redis (如 AWS ElastiCache, Redis Cloud)

### Q3: 和之前的 Motia 版本有什么区别？

| 对比项 | Motia 版本 | 新版本 (Express) |
|--------|-----------|-----------------|
| 启动命令 | `motia dev` | `npm run dev` |
| 依赖框架 | motia | express + bull + redis |
| Redis | 可选 | **必须** |
| 部署方式 | motia build | npm run build |
| Windows 兼容 | ❌ 有问题 | ✅ 完美支持 |

### Q4: 我该选哪种方式？

**开发阶段**:
```bash
# 方式一：本地开发 (最简单)
npm install
# 启动 Redis (任选一种方式)
npm run dev
```

**生产部署**:
```bash
# 方式二：Docker Compose (推荐)
docker-compose up -d
```

---

## 验证运行状态

### 健康检查
```bash
curl http://localhost:3000/health
```

应返回:
```json
{
  "status": "healthy",
  "timestamp": "2026-01-19T12:00:00.000Z",
  "redis": {
    "status": "connected"
  },
  "queue": {
    "waiting": 0,
    "active": 0,
    "completed": 10,
    "failed": 0
  }
}
```

### 测试生成视频
```bash
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "concept": "勾股定理",
    "quality": "low"
  }'
```

---

## 快速决策树

```
需要运行 ManimGo？
│
├─ 是开发调试？
│  └─> 用方式一：本地开发 (npm run dev)
│
├─ 是生产部署？
│  ├─ 有 Docker？
│  │  └─> 用方式二：Docker Compose (推荐)
│  │
│  └─ 没有 Docker？
│     └─> 用方式三：裸机部署 (npm start)
│
└─ 只是想快速测试？
   └─> 用方式二：Docker Compose (最快)
```

---

## 关键点总结

1. ✅ **不再使用 Motia 框架** - 改用 Express.js
2. ✅ **Redis 是必须的** - 但运行方式灵活
3. ✅ **Docker 是可选的** - 三种部署方式任选
4. ✅ **开发用 `npm run dev`** - 不再是 `motia dev`
5. ✅ **生产用 `npm start`** - 不再是 `motia start`

现在的架构更标准、更灵活、更容易理解和维护！