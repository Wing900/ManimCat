# ä»£ç æ¸…ç†è®¡åˆ’

**ç›®æ ‡ï¼šç§»é™¤ Motia é—ç•™ä»£ç ï¼Œä¿ç•™å¿…è¦çš„ä¸šåŠ¡é€»è¾‘**

---

## ğŸ“‹ éœ€è¦æ¸…ç†çš„æ–‡ä»¶

### ğŸ—‘ï¸ å¯ä»¥ç›´æ¥åˆ é™¤ï¼ˆå·²è¢«æ–°ä»£ç æ›¿ä»£ï¼‰

#### API å±‚ï¼ˆå·²è¢« src/routes/ æ›¿ä»£ï¼‰
- [ ] `src/api/generate.step.ts` â†’ å·²è¢« `src/routes/generate.route.ts` æ›¿ä»£
- [ ] `src/api/job-status.step.ts` â†’ å·²è¢« `src/routes/job-status.route.ts` æ›¿ä»£  
- [ ] `src/api/health.step.ts` â†’ å·²è¢« `src/routes/health.route.ts` æ›¿ä»£
- [ ] `src/api/openai-compatible.step.ts.disabled` â†’ æœªä½¿ç”¨

#### ä¸­é—´ä»¶ï¼ˆå·²è¢«æ–°ä¸­é—´ä»¶æ›¿ä»£ï¼‰
- [ ] `src/middlewares/core.middleware.ts` â†’ å·²è¢« `src/middlewares/error-handler.ts` æ›¿ä»£
- [ ] `src/middlewares/auth.middleware.ts` â†’ å¦‚æœæœªä½¿ç”¨åˆ™åˆ é™¤

#### é”™è¯¯ç±»ï¼ˆå·²è¢« src/utils/errors.ts æ›¿ä»£ï¼‰
- [ ] `src/errors/base.error.ts` â†’ å·²è¢« `src/utils/errors.ts` ä¸­çš„ `AppError` æ›¿ä»£
- [ ] `src/errors/validation.error.ts` â†’ å·²è¢« `src/utils/errors.ts` ä¸­çš„ `ValidationError` æ›¿ä»£
- [ ] `src/errors/not-found.error.ts` â†’ å·²è¢« `src/utils/errors.ts` ä¸­çš„ `NotFoundError` æ›¿ä»£

#### é…ç½®æ–‡ä»¶
- [ ] `motia.config.ts` â†’ Motia é…ç½®æ–‡ä»¶ï¼Œä¸å†éœ€è¦

---

## â™»ï¸ éœ€è¦æ”¹é€ ï¼ˆä¿ç•™ä¸šåŠ¡é€»è¾‘ï¼Œç§»é™¤ Motia ä¾èµ–ï¼‰

### äº‹ä»¶å¤„ç†å™¨ï¼ˆéœ€è¦åœ¨ Part 3 æ”¹é€ ä¸º processorï¼‰
è¿™äº›æ–‡ä»¶åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œ**æš‚æ—¶ä¿ç•™**ï¼Œç­‰ Part 3 åˆ›å»º `video.processor.ts` æ—¶æ•´åˆï¼š

- [ ] `src/events/check-cache.step.ts` - ç¼“å­˜æ£€æŸ¥é€»è¾‘
- [ ] `src/events/analyze-concept.step.ts` - æ¦‚å¿µåˆ†æé€»è¾‘
- [ ] `src/events/generate-code.step.ts` - ä»£ç ç”Ÿæˆé€»è¾‘
- [ ] `src/events/render-video.step.ts` - è§†é¢‘æ¸²æŸ“é€»è¾‘
- [ ] `src/events/handle-cache-hit.step.ts` - ç¼“å­˜å‘½ä¸­å¤„ç†
- [ ] `src/events/store-result.step.ts` - ç»“æœå­˜å‚¨é€»è¾‘

**æ”¹é€ ç­–ç•¥ï¼š**
```typescript
// ä» Motia Event æ”¹ä¸ºæ™®é€šå‡½æ•°
// åŸæ¥ï¼šexport const handler: Handlers['xxx'] = async (input, { emit, state, logger })
// æ”¹ä¸ºï¼šexport async function xxxStep(input: XxxInput): Promise<XxxOutput>
```

---

## âœ… éœ€è¦ä¿ç•™ï¼ˆçº¯ä¸šåŠ¡é€»è¾‘ï¼Œæ— æ¡†æ¶ä¾èµ–ï¼‰

### æœåŠ¡å±‚ï¼ˆå·²ç»æ˜¯æ¡†æ¶æ— å…³çš„ï¼‰
- âœ… `src/services/openai-client.ts` - OpenAI å°è£…ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰
- âœ… `src/services/manim-templates.ts` - æ¨¡æ¿ç³»ç»Ÿï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰
- âœ… `src/services/concept-cache.ts` - ç¼“å­˜æœåŠ¡ï¼ˆå¯èƒ½éœ€è¦å°æ”¹ï¼Œæ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† Motia stateï¼‰
- âœ… `src/services/job-store.ts` - å·²æ”¹é€ å®Œæˆ

---

## ğŸ¯ æ¸…ç†æ‰§è¡Œé¡ºåº

### Phase 1: åˆ é™¤æ˜ç¡®åºŸå¼ƒçš„æ–‡ä»¶ï¼ˆç«‹å³æ‰§è¡Œï¼‰
```bash
# åˆ é™¤æ—§ API æ–‡ä»¶
rm src/api/generate.step.ts
rm src/api/job-status.step.ts
rm src/api/health.step.ts
rm src/api/openai-compatible.step.ts.disabled

# åˆ é™¤æ—§ä¸­é—´ä»¶
rm src/middlewares/core.middleware.ts
# æ£€æŸ¥ååˆ é™¤ï¼šrm src/middlewares/auth.middleware.ts

# åˆ é™¤æ—§é”™è¯¯ç±»
rm src/errors/base.error.ts
rm src/errors/validation.error.ts
rm src/errors/not-found.error.ts

# åˆ é™¤ Motia é…ç½®
rm motia.config.ts
```

### Phase 2: æ£€æŸ¥ä¾èµ–å…³ç³»
åœ¨åˆ é™¤å‰ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–‡ä»¶è¿˜åœ¨å¼•ç”¨è¿™äº›æ–‡ä»¶ï¼š
```bash
# æ£€æŸ¥å¼•ç”¨
grep -r "from '../api/" src/
grep -r "from '../errors/" src/
grep -r "core.middleware" src/
grep -r "auth.middleware" src/
```

### Phase 3: æ”¹é€  concept-cache.tsï¼ˆå¦‚æœéœ€è¦ï¼‰
æ£€æŸ¥ `src/services/concept-cache.ts` æ˜¯å¦ä½¿ç”¨äº† Motia çš„ `state` APIï¼š
- å¦‚æœä½¿ç”¨äº†ï¼Œæ”¹ä¸ºç›´æ¥ä½¿ç”¨ `redisClient`
- å¦‚æœæ²¡æœ‰ä½¿ç”¨ï¼Œä¿æŒä¸å˜

### Phase 4: ç­‰å¾… Part 3 å®Œæˆåæ¸…ç†
åœ¨ `video.processor.ts` åˆ›å»ºå¹¶æµ‹è¯•é€šè¿‡åï¼š
```bash
# åˆ é™¤æ—§çš„äº‹ä»¶å¤„ç†å™¨
rm -rf src/events/
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦åˆ é™¤ç©ºç›®å½•
æŸäº›å·¥å…·å¯èƒ½ä¾èµ–ç›®å½•ç»“æ„ï¼Œå…ˆåˆ é™¤æ–‡ä»¶ï¼Œä¿ç•™ç©ºç›®å½•ã€‚

### 2. Git æäº¤ç­–ç•¥
```bash
# åˆ†æ‰¹æäº¤ï¼Œæ–¹ä¾¿å›æ»š
git add src/api/
git commit -m "chore: remove old Motia API files"

git add src/middlewares/
git commit -m "chore: remove old Motia middlewares"

git add src/errors/
git commit -m "chore: remove old error classes"

git add motia.config.ts
git commit -m "chore: remove Motia config"
```

### 3. æ£€æŸ¥ TypeScript ç¼–è¯‘
æ¯åˆ é™¤ä¸€æ‰¹æ–‡ä»¶åï¼Œè¿è¡Œï¼š
```bash
npm run build
```
ç¡®ä¿æ²¡æœ‰ç ´åå…¶ä»–å¼•ç”¨ã€‚

### 4. æ›´æ–° tsconfig.jsonï¼ˆå¦‚æœéœ€è¦ï¼‰
åˆ é™¤æ–‡ä»¶åï¼Œæ£€æŸ¥ `tsconfig.json` æ˜¯å¦éœ€è¦æ›´æ–° `include`/`exclude` é…ç½®ã€‚

---

## ğŸ“Š æ¸…ç†å‰åå¯¹æ¯”

### æ–‡ä»¶æ•°é‡å˜åŒ–
| ç±»åˆ« | æ¸…ç†å‰ | æ¸…ç†å | å‡å°‘ |
|------|--------|--------|------|
| API æ–‡ä»¶ | 4 | 0 | -4 |
| è·¯ç”±æ–‡ä»¶ | 0 | 4 | +4 |
| ä¸­é—´ä»¶ | 2 | 2 | 0 |
| é”™è¯¯ç±» | 3 | 0 | -3 |
| äº‹ä»¶å¤„ç†å™¨ | 6 | 0 (â†’processor) | -6 |
| é…ç½®æ–‡ä»¶ | 1 | 0 | -1 |
| **æ€»è®¡** | **16** | **6** | **-10** |

### ä»£ç è¡Œæ•°å˜åŒ–ï¼ˆé¢„ä¼°ï¼‰
- åˆ é™¤ï¼š~500 è¡Œï¼ˆæ—§ Motia ä»£ç ï¼‰
- æ–°å¢ï¼š~600 è¡Œï¼ˆExpress + Bull ä»£ç ï¼‰
- å‡€å¢ï¼š~100 è¡Œ

---

## âœ… æ¸…ç†éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰æ—§çš„ Motia API æ–‡ä»¶å·²åˆ é™¤
- [ ] æ‰€æœ‰æ—§çš„é”™è¯¯ç±»å·²åˆ é™¤
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] npm run dev å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] æ²¡æœ‰æœªä½¿ç”¨çš„ import è¯­å¥
- [ ] Git å†å²æ¸…æ™°ï¼ˆåˆ†æ‰¹æäº¤ï¼‰

---

## ğŸš€ æ‰§è¡Œå»ºè®®

**ç°åœ¨ç«‹å³æ‰§è¡Œ Phase 1ï¼Œå…¶ä»– Phase ç­‰ Part 3 å®Œæˆåå†æ‰§è¡Œã€‚**

ç†ç”±ï¼š
- Phase 1 çš„æ–‡ä»¶å·²ç»å®Œå…¨è¢«æ›¿ä»£ï¼Œä¸åˆ é™¤ä¼šé€ æˆæ··æ·†
- Phase 2-4 æ¶‰åŠä¸šåŠ¡é€»è¾‘ï¼Œéœ€è¦æ›´è°¨æ…
- åˆ†æ­¥éª¤æ¸…ç†ï¼Œé£é™©æ›´å°

---

*åˆ›å»ºæ—¶é—´ï¼š2026-01-19*  
*ä½œè€…ï¼šæŒ‡æŒ¥å®˜ Kilo Code*